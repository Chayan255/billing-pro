generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* =======================
   ENUMS
======================= */
enum Role {
  ADMIN
  STAFF
  CASHIER
}

enum BusinessType {
  MEDICINE
  GROCERY
  SHOPPING_MALL
  GARMENTS
}

enum PaymentMethod {
  CASH
  UPI
  CARD
}

enum DiscountType {
  FLAT
  PERCENT
}

enum GstType {
  CGST_SGST
  IGST
}

enum StockType {
  PURCHASE
  MANUAL
  BILL
  IMPORT
}

/* =======================
   USER (BUSINESS OWNER)
======================= */
model User {
  id            Int          @id @default(autoincrement())
  name          String
  email         String       @unique
  password      String
  role          Role
  businessType  BusinessType
  businessName  String
  isVerified    Boolean      @default(false)
  createdAt     DateTime     @default(now())

  products   Product[]
  customers  Customer[]
  bills      Bill[]
  purchases  Purchase[]
  stockLogs  StockLog[]
  cartItems  CartItem[]
}

/* =======================
   CUSTOMER
======================= */
model Customer {
  id Int @id @default(autoincrement())

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  name      String
  phone     String?
  gstin     String?
  createdAt DateTime @default(now())

  bills Bill[]

  @@index([ownerId])
}

/* =======================
   PRODUCT
======================= */
model Product {
  id Int @id @default(autoincrement())

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  name          String
  sku           String
  price         Float
  stock         Int
  category      String
  hsnCode       String?
  lowStockLevel Int      @default(5)
  createdAt     DateTime @default(now())

  billItems BillItem[]
  cartItems CartItem[]
  stockLogs StockLog[]
  purchases Purchase[]

  @@unique([ownerId, sku]) // ðŸ”’ SKU unique per business
  @@index([ownerId])
}

/* =======================
   BILL
======================= */
model Bill {
  id Int @id @default(autoincrement())

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  /* ðŸ”’ COMPANY SNAPSHOT */
  companyName      String
  companyGstin     String?
  companyAddress   String?
  companyState     String?
  companyStateCode String?

  customerId     Int?
  customer       Customer? @relation(fields: [customerId], references: [id])

  customerName   String?
  customerMobile String?
  customerGstin  String?

  gstType       GstType
  gstPercent    Float
  taxableAmount Float
  cgst          Float
  sgst          Float
  igst          Float

  totalDiscount Float
  roundOff      Float
  totalAmount   Float

  paymentMethod PaymentMethod
  notes         String?

  createdAt DateTime @default(now())

  items BillItem[]

  @@index([ownerId])
}

/* =======================
   BILL ITEM
======================= */
model BillItem {
  id Int @id @default(autoincrement())

  billId    Int
  productId Int

  quantity Int
  price    Float

  discount     Float
  discountType DiscountType
  gstPercent   Float
  lineTotal    Float

  bill    Bill    @relation(fields: [billId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

/* =======================
   CART ITEM
======================= */
model CartItem {
  id Int @id @default(autoincrement())

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  price    Float

  discount     Float
  discountType DiscountType
  gstPercent   Float

  createdAt DateTime @default(now())

  @@index([ownerId])
  @@index([productId])
}

/* =======================
   STOCK LOG (AUDIT)
======================= */
model StockLog {
  id Int @id @default(autoincrement())

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  change Int
  type   StockType
  reason String? @db.VarChar(255)

  createdAt DateTime @default(now())

  @@index([ownerId])
  @@index([productId])
  @@map("stocklog")
}

/* =======================
   PURCHASE
======================= */
model Purchase {
  id Int @id @default(autoincrement())

  ownerId Int
  owner   User @relation(fields: [ownerId], references: [id])

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  supplier  String
  quantity  Int
  costPrice Float?

  createdAt DateTime @default(now())

  @@index([ownerId])
  @@index([productId])
  @@map("purchase")
}
