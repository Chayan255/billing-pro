generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/**
 * =======================
 * ENUMS
 * =======================
 */
enum Role {
  ADMIN
  STAFF
  CASHIER
}

enum PaymentMethod {
  CASH
  UPI
  CARD
}

enum DiscountType {
  FLAT
  PERCENT
}

enum GstType {
  CGST_SGST
  IGST
}

enum StockType {
  PURCHASE
  MANUAL
  BILL
  IMPORT
}

/**
 * =======================
 * USER
 * =======================
 */
model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())

  // relations
  stockLogs StockLog[]
  purchases Purchase[]
}

/**
 * =======================
 * CUSTOMER
 * =======================
 */
model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  gstin     String?
  createdAt DateTime @default(now())

  bills Bill[]
}

/**
 * =======================
 * PRODUCT
 * =======================
 */
model Product {
  id        Int      @id @default(autoincrement())
  name      String
  sku       String   @unique
  price     Float
  stock     Int
  category  String
  hsnCode        String? 
   lowStockLevel  Int      @default(5) 
  createdAt DateTime @default(now())

  billItems BillItem[]
  cartItems CartItem[]
  stockLogs StockLog[]
  purchases Purchase[]
}

/**
 * =======================
 * BILL
 * =======================
 */
model Bill {
  id Int @id @default(autoincrement())

  /* ======================
     CUSTOMER SNAPSHOT
  ====================== */
  customerName   String?
  customerMobile String?
  customerGstin  String?        // ✅ NEW
  customerId     Int?
  customer       Customer? @relation(fields: [customerId], references: [id])

  /* ======================
     COMPANY SNAPSHOT
  ====================== */
  companyName       String  @default("Billing Pro")
  companyGstin      String?
  companyAddress    String?
  companyState      String?     // ✅ NEW
  companyStateCode  String?     // ✅ NEW

  /* ======================
     GST
  ====================== */
  gstType       GstType
  gstPercent    Float
  taxableAmount Float
  cgst          Float
  sgst          Float
  igst          Float

  /* ======================
     TOTALS
  ====================== */
  totalDiscount Float
  roundOff      Float          // ✅ already used in code
  totalAmount   Float

  /* ======================
     PAYMENT
  ====================== */
  paymentMethod PaymentMethod
  notes         String?

  createdAt DateTime @default(now())

  items BillItem[]
}

/**
 * =======================
 * BILL ITEM
 * =======================
 */
model BillItem {
  id        Int @id @default(autoincrement())
  billId    Int
  productId Int

  quantity Int
  price    Float

  discount     Float
  discountType DiscountType
  gstPercent   Float
  lineTotal    Float

  bill    Bill    @relation(fields: [billId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

/**
 * =======================
 * CART ITEM
 * =======================
 */
model CartItem {
  id        Int @id @default(autoincrement())
  userId    Int
  productId Int

  quantity Int
  price    Float

  discount     Float
  discountType DiscountType
  gstPercent   Float

  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])
}

/**
 * =======================
 * STOCK LOG (AUDIT)
 * =======================
 */
model StockLog {
  id Int @id @default(autoincrement())

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  change Int
  type   StockType
  reason String? @db.VarChar(255)

  createdBy Int
  user      User @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])

  @@map("stocklog") 
}

/**
 * =======================
 * PURCHASE
 * =======================
 */
model Purchase {
  id Int @id @default(autoincrement())

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  supplier  String
  quantity  Int
  costPrice Float?

  createdBy Int
  user      User @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])

   @@map("purchase")
}
